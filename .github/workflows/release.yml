# ============================================================
#  OCRtoODT â€” GitHub Actions Release Workflow
#  File: .github/workflows/release.yml
#
#  Responsibility:
#      - Build Release binary on tag push (v*)
#      - Use SYSTEM dependencies (Qt6 + Poppler-Qt6 + OpenCV + Tesseract)
#      - Upload built executable as workflow artifact
#
#  Notes:
#      - Use ubuntu-22.04 explicitly because:
#          * libpoppler-qt6-dev is reliably available there
#          * stable dependency resolution
# ============================================================

name: Build AppImage Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Install dependencies
      # ------------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
	      build-essential \
	      cmake \
	      ninja-build \
	      qt6-base-dev \
	      qt6-tools-dev \
	      qt6-tools-dev-tools \
	      qt6-multimedia-dev \
	      libpoppler-qt6-dev \
	      libopencv-dev \
	      libtesseract-dev \
	      libleptonica-dev \
	      libxkbcommon-dev \
	      wget \
	      file \
	      fuse \
	      patchelf

      # ------------------------------------------------------------
      # Configure + Build
      # ------------------------------------------------------------
      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -G Ninja

      - name: Build
        run: cmake --build build

      # ------------------------------------------------------------
      # Install into AppDir
      # ------------------------------------------------------------
      - name: Install into AppDir
        run: |
          cmake --install build --prefix AppDir/usr

      # ------------------------------------------------------------
      # Download linuxdeploy
      # ------------------------------------------------------------
      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage

      # ------------------------------------------------------------
      # Build AppImage
      # ------------------------------------------------------------
      - name: Create AppImage
        env:
          QMAKE: /usr/lib/qt6/bin/qmake
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/OCRtoODT \
            --desktop-file AppDir/usr/share/applications/OCRtoODT.desktop \
            --icon-file resources/icons/ocrtoodt.png \
            --plugin qt \
            --output appimage

      # ------------------------------------------------------------
      # Upload Release Asset
      # ------------------------------------------------------------
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: OCRtoODT-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

